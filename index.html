<!DOCTYPE html>
<title>BITTERSWEET BROUGHLIKE</title>

<style>
  canvas {
    outline: 2px solid #f8edd7;
    background-color: #bebae3;
  }

  body {
    background-color: rgb(117, 145, 193);
    text-align: center;
    margin-top: 50px;
  }

  .menu-wrapper {
    text-align: center;
    margin-bottom: 10px;
  }

  .toggle-outfits {
    margin-bottom: 12px;
    font-size: 13px;
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid #888;
    background: #f8edd7;
    cursor: pointer;
  }

  .outfit-buttons {
    margin-bottom: 12px;
    display: block;
  }
  .outfit-buttons.hidden {
    display: none;
  }
  .outfit-buttons button {
    margin: 0 3px;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid #888;
    background: #f8edd7;
    cursor: pointer;
  }

  #tooltip {
    position: absolute;
    display: none;
    background: #222;
    color: #fff;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 13px;
    pointer-events: none;
    z-index: 10;
    font-family: monospace;
  }
</style>

<div id="menu-wrapper">
  <button class="toggle-outfits" onclick="toggleOutfitButtons()">
    Toggle Outfits
  </button>
  <div class="outfit-buttons" id="outfit-buttons">
    <button onclick="if(player)setOutfitAndDraw(0)">Outfit 1</button>
    <button onclick="if(player)setOutfitAndDraw(16)">Outfit 2</button>
    <button onclick="if(player)setOutfitAndDraw(32)">Outfit 3</button>
    <button onclick="if(player)setOutfitAndDraw(48)">Outfit 4</button>
    <button onclick="setMaxSpells9()">Max Spells</button>
  </div>
</div>

<div id="tooltip"></div>
<canvas></canvas>
<script src="js/game.js"></script>
<script src="js/map.js"></script>
<script src="js/tile.js"></script>
<script src="js/monster.js"></script>
<script src="js/util.js"></script>
<script src="js/spell.js"></script>
<script>
  tileSize = 64;
  numTiles = 10;
  uiWidth = 2;
  level = 1;
  maxHp = 6;

  spritesheet = new Image();
  spritesheet.src = "spritesheet.png";
  spritesheet.onload = showTitle;

  gameState = "loading";
  startingHp = 3;
  numLevels = 6;

  shakeAmount = 0;
  shakeX = 0;
  shakeY = 0;

  // helper to safely set outfit and redraw
  function setOutfitAndDraw(offset) {
    if (player && typeof player.setOutfit === "function") {
      player.setOutfit(offset);
      draw();
    }
  }

  function toggleOutfitButtons() {
    const div = document.getElementById("outfit-buttons");
    div.classList.toggle("hidden");
  }

  function setMaxSpells9() {
    numSpells = 9;
    // Optionally, fill up the player's spells if needed
    if (player && player.spells) {
      while (player.spells.length < 9) {
        player.addSpell();
      }
    }
    draw();
  }

  document.querySelector("html").onkeypress = function (e) {
    if (gameState == "title") {
      startGame();
    } else if (gameState == "dead") {
      showTitle();
    } else if (gameState == "running") {
      if (e.key == "w") player.tryMove(0, -1);
      if (e.key == "s") player.tryMove(0, 1);
      if (e.key == "a") player.tryMove(-1, 0);
      if (e.key == "d") player.tryMove(1, 0);

      if(e.key>=1 && e.key<=9) player.castSpell(e.key-1);
    }
  };

  setInterval(draw, 15);

  setupCanvas();

  initSounds();

  // Tooltip logic for enemy hover
  const tooltip = document.getElementById("tooltip");
  const canvasRect = () => canvas.getBoundingClientRect();

  canvas.addEventListener("mousemove", function (e) {
    const rect = canvasRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const tileX = Math.floor(mouseX / tileSize);
    const tileY = Math.floor(mouseY / tileSize);

    // Find monster at mouse position
    let hovered = monsters.find(
      (m) => m.tile.x === tileX && m.tile.y === tileY && !m.dead
    );
    // Only show tooltip if monster exists, has a description, and teleportCounter is 0 or less
    if (hovered && hovered.description && hovered.teleportCounter <= 0) {
      tooltip.textContent = hovered.description;
      tooltip.style.left = e.clientX + 16 + "px";
      tooltip.style.top = e.clientY + 16 + "px";
      tooltip.style.display = "block";
    } else {
      tooltip.style.display = "none";
    }
  });

  canvas.addEventListener("mouseleave", function () {
    tooltip.style.display = "none";
  });
</script>
